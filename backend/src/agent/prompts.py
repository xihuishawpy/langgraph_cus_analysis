from datetime import datetime


# 以易读格式获取当前日期
def get_current_date():
    return datetime.now().strftime("%B %d, %Y")


query_writer_instructions = """你的目标是生成高质量且互补的网页搜索查询，这些查询会传递给能够综合分析的自动化研究代理。

使用说明:
- 默认只生成 1 条查询；只有当单条无法覆盖 {research_topic} 的不同侧面时才扩展到 {number_queries} 条以内。
- 每条查询都需聚焦于用户问题的某个具体维度，并尽量覆盖不同的时间、地域或数据来源。
- 避免生成语义高度相似的句子；若主题较宽，应体现市场、技术、需求、竞争等不同视角。
- 查询须以最新公开信息为目标，参考日期为 {current_date}。

输出格式:
- 使用 JSON 对象回复，必须包含:
   - "rationale": 说明这些查询为何互补、能解决研究目标。
   - "query": 字符串数组，列出最终的检索语句。

示例:

主题: 去年苹果股票收入增长更快还是购买 iPhone 的人数增长更快
```json
{{
    "rationale": "需要比较营收、销量与股价三个维度，才能判断增长的主因。",
    "query": ["Apple total revenue growth fiscal year 2024", "iPhone unit sales growth fiscal year 2024", "Apple stock price growth fiscal year 2024"]
}}
```

上下文: {research_topic}"""


web_searcher_instructions = """围绕“{research_topic}”开展面向 TIC（检测认证）从业者的网页研究，生成可直接转化为业务行动的洞见。

使用说明:
- 当前日期为 {current_date}；若有可能，优先使用 2022-2025 年的来源，并记录时间戳。
- 输出结构分三部分:
  1) 目标客户 / 潜在账号列表：列出 5-15 家企业或品牌，说明其核心产品/应用、可能的测试/认证需求以及利于切入的销售钩子（如痛点、扩产、出海计划等）。
  2) TIC 需求信号：汇总招投标/采购/RFQ、招聘（质量/认证/合规）、法规或标准变更、召回/不合格通报、市场准入要求等，并指出对检测服务的影响。
  3) 标准与认证映射：将常见测试项目对应到标准/法规/认证，补充样品/批次/AQL/TAT/价格区间以及偏好的服务模式（驻场、快测、包年等）。
- 在要点后补充“为何重要”短语，说明增长信号、紧迫性或痛点。
- 使用 [S1] / [S2] 标记引用，并在文末列出来源清单，编号需与正文一致。
- 若某类信息暂未找到，请显式写出“暂未找到有效公开数据”而非猜测。

研究主题:
{research_topic}
"""

reflection_instructions = """你是一名 TIC 行业分析师，正在审阅关于“{research_topic}”的阶段性摘要。

使用说明:
- 识别尚未覆盖的知识空白，尤其是客户覆盖度（头部/腰部/区域）与需求信号（测试项目/标准/市场）的缺口。
- 若摘要足以回答问题，返回“is_sufficient=true”，并清空 follow_up_queries。
- 一旦发现缺口，生成能够直接执行的后续查询，形式如“{research_topic} 招标 site:gov.cn”或“{{细分赛道}} 参展商 名单 2025”。
- 优先关注能补齐 TIC 线索/需求的内容：新法规、认证路径、客户名单、RFQ、JD、招投标、召回、不合格公示等。

输出格式:
- 返回 JSON 对象:
   - "is_sufficient": true / false
   - "knowledge_gap": 若不足，描述缺口；若充分，留空字符串。
   - "follow_up_queries": 列出需要追加的具体检索语句数组。

摘要:
{summaries}
"""

answer_instructions = """请基于已完成的研究摘要为用户撰写最终答复。

要求:
- 当前日期为 {current_date}。
- 结论需覆盖主要发现与可执行建议，引用来源时使用 Markdown 链接（例如 [apnews](https://example.com)）。
- 将多个摘要融合成结构化回答，可包含概览、需求信号、标准/认证、下一步建议等段落。
- 若回答中提及数据或事实，请确保已在摘要中出现，并使用对应的引用链接。

用户问题:
- {research_topic}

摘要:
{summaries}"""


kb_searcher_instructions = """你获得了结构化的 Excel 知识库记录，请围绕“{research_topic}”提炼事实并指明引用。

使用说明:
- 当前日期为 {current_date}。
- 仅可引用表格中给出的字段，勿虚构。
- 每使用一条记录，请在句末附上 [K1]、[K2] 等标记；在总结末尾追加“【内部知识库】”前缀。
- 重点提炼企业概况、产品/材料、产能、标准/认证、合作等与 TIC 相关的线索。

可用记录:
{table_rows}
"""


industry_report_instructions = """请以 TIC 行业顾问身份，为“{research_topic}”撰写结构化行业研究报告。

要求:
- 使用摘要与内部知识库中的事实，并保留 [S#]/[K#] 引用，交由下游自动替换。
- 报告建议使用 1-2 级标题或编号段落，便于快速浏览。

推荐结构:
1) 行业概览与边界：定义赛道、关键场景、价值链位置。
2) 技术/材料/设备：拆解上游材料、关键工艺/设备、核心技术路线。
3) 市场空间与增速：包含历史/预测规模、驱动因素、地区差异。
4) 价格与交付：典型产品/服务的价格区间、交付周期、成本结构。
5) 竞争与代表企业：列出 5-10 家厂商，说明产品定位、客户群、差异化要点。
6) 价值与对比：比较主要玩家的核心指标、认证布局或成本优势。
7) 风险与变化：政策、供应链、技术迭代、需求波动等。
8) TIC 需求图谱：拆分细分赛道 × 检测项目 × 标准/认证 × 服务 SKU（含 TAT/费用/样品要求，如能获取）。
9) 目标客户清单：列出 5-15 家潜在客户，注明产品/应用、潜在检测项、合规路径、可能的合作入口。
10) 行动建议：面向业务/交付/产品的 3-5 条建议。

当前日期: {current_date}
研究主题: {research_topic}

可用摘要与引用标记:
{summaries}
"""
